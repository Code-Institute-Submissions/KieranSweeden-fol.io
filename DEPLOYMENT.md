# <img src="readme/images/general/fol.io-short-logo-readme-header.png" height="25"> fol.io Deployment

Within this markdown file, you'll find various deployment procedures that need to be undertaken in order to obtain your own version of fol.io.

<a href="https://folio-web-app.herokuapp.com/" target="_blank">Link to live deployment of fol.io</a>

To navigate back to the README file, [click here](README.md).

## Table of Contents

* [Prerequisites](#prerequisites)
* [Clone fol.io Locally](#clone-folio-locally)
* [Deploy fol.io live with Heroku](#deploy-folio-live-with-heroku)
* [Create an AWS S3 Bucket](#create-an-aws-s3-bucket)
* [Provide fol.io access to S3 Bucket via AWS IAM](#provide-folio-access-to-s3-bucket-via-aws-iam)

## Prerequisites

The following is a list of prerequisites that are required in order to deploy fol.io.

- Python 3 installed (Along with pip to install packages listed within the requirements.txt file).
- Git installed to proceed with git commands that make deployment possible.
- An IDE of your choice to access the fol.io codebase.
- A Stripe account to enable card payment functionality.
- An AWS account with access to S3 (Along with a created S3 bucket to contain static files).

[Return to Table of Contents &#8679;](#table-of-contents)

## Clone fol.io Locally

The following are procedures that need to be undertaken in order to run a local version of fol.io.

1. Create an account / sign in with [GitHub](https://github.com/).
2. Re-direct to the main page of the [fol.io respository](https://github.com/KieranSweeden/fol.io).
3. Click the "Code" dropdown button located above the amount of commits made to the GitHub repository.
4. Copy the URL link provided within the dropdown that appears after clicking the "Code" button.
5. Using the terminal found within your chosen IDE, move your current working directory to a place where you'd like to store your local version of fol.io.
6. Enter the following git command within the terminal of your IDE to clone the fol.io codebase:
    ```bash
    git clone https://github.com/KieranSweeden/fol.io.git
    ```
    You should now see the contents of your current working directory filled within the fol.io codebase.
7. Store the following environment variables in a way that you prefer, an example of which could be storing them within a file that's gitignored and will therefore not be pushed to a remote repository online. Although the original version used environment variables via Gitpod, the following will assume your proceeding with popular env.py method.
    ```python
    import os

    # Django environment variables
    os.environ.setdefault('DEVELOPMENT', True)
    os.environ.setdefault('SECRET_KEY', <SECRET_KEY>)

    # Stripe environment variables
    os.environ.setdefault('STRIPE_PUBLIC_KEY', <STRIPE_PUBLIC_KEY>)
    os.environ.setdefault('STRIPE_SECRET_KEY', <STRIPE_SECRET_KEY>)
    os.environ.setdefault('STRIPE_ENDPOINT_SECRET', <STRIPE_ENDPOINT_SECRET>)
    os.environ.setdefault('FOLIO_LICENSE_PRICE_ID', <FOLIO_LICENSE_PRICE_ID>)
    ```
    <details>

    <summary>Environment Variables Explainers</summary>

    - DEVELOPMENT
        - This is used to run particular code when the codebase is within it's development environment.
    - SECRET_KEY
        - This can be any secret key of your choice. A recommended secret key generator could be any of the longer keys found within [RandomKeyGen](https://randomkeygen.com/).
    - STRIPE_PUBLIC_KEY
        - This is a public key generated by Stripe. This can be found under the alias of "Publishable Key" within the Stripe dashboard under the API keys tab.
    - STRIPE_PRIVATE_KEY
        - This is a private "Test Secret Key" that's generated by Stripe and can also be found within the API keys tab within the Stripe dashboard.
    - STRIPE_ENDPOINT_SECRET
        - This is a unique secret key generated by Stripe for the webhook that handles payments with the fol.io application. To find this, ensure you've created a webhook url that matches the webhook url found within the fol.io application (<site_url>/license/checkout/webhook/). You can then find the endpoint secret under the alias of "Signing secret" within the page dedicated to the webhook on the Stripe dashboard.
    - FOLIO_LICENSE_PRICE_ID
        - This is a unique Stripe API ID that's used to verify the product being purchased, in this case it's fol.io licenses. This can be obtained by creating a fol.io license product within the Products section of the Stripe dashboard.

    </details>

8. With your environment variables saved and working as expected, you can now install all of the required packages listed within the requirements.txt by entering the following command:
    ```bash
    pip3 install requirements.txt
    ```

9. With the dependency packages all installed, you should now process the necessary database migrations by entering the following commands:
    ```bash
    python manage.py makemigrations
    ```

    ```bash
    python manage.py migrate
    ```

10. The application is now all set! However, you don't have a way to login as an administrator. To create a new admin account, enter the following command and follow the steps it provides to create a new superuser:
    ```bash
    python manage.py createsuperuser
    ```

11. You're all set. All that's left to do is to launch the server, which can be done by simply entering the following command:
    ```bash
    python manage.py runserver
    ```

12. With the application now live on your local environment, you can now add "/admin" to the end of the url and sign in using the superuser account you recently created.

[Return to Table of Contents &#8679;](#table-of-contents)

## Deploy fol.io live with Heroku

The following are procedures that need to be undertaken in order to run a deployed version of fol.io using Heroku.

1. Create an account / sign in with Heroku.

2. With the Heroku Apps dashboard select "Create new app" which can be found by clicking the "New" dropdown button at the top right of the dashboard.

3. Heroku will then ask you to provide a unique app name and to choose a particular region. When choosing a region, please ensure that you choose the region that's closest to you.

4. When the new Heroku app has been created, navigate to the app dashboard and select the resources tab. Within the add-ons section, attach the "Heroku Postgres" add-on to the app, selecting the free "Hobby Dev" option. This is a managed SQL database service that will allow the newly created app to access a Heroku Postgres database.

5. With the Postgres add-on successfully installed, you're now going to want to add the following environment variables to Heroku within the "Config Vars" section found under the settings tab of the app dashboard:
    | Variable Key           | Variable Value                                 |
    |------------------------|------------------------------------------------|
    | DATABASE_URL           | {auto generated by postgres add-on}            |
    | USE_AWS                | True                                           |
    | STRIPE_PUBLIC_KEY      | {found within API keys section in stripe dash} |
    | STRIPE_PRIVATE_KEY     | {found within API keys section in stripe dash} |
    | STRIPE_ENDPOINT_SECRET | {found within webhook dash on stripe}          |
    | FOLIO_LICENSE_PRICE_ID | {found within product dash on stripe}          |
    | S3_ACCESS_KEY_ID       | {found within IAM in AWS dash}                 |
    | S3_SECRET_ACCESS_KEY   | {found within IAM in AWS dash}                 |
    | EMAIL_HOST_PASS        | {password for application access to mail}      |
    | EMAIL_HOST_USER        | {email that'll appear on default mail messages}|
    | URL                    | {deployed app url - is planned to change}      |

6. We're now going to install the packages needed to utilise Postgres when deployed on Heroku. Install dj_database_url and psychopg2 using the following commands:
    ```bash
    pip3 install dj_database_url
    ```

    ```bash
    pip3 install psychopg2
    ```

7. An additional package we're going to need to install is gunicorn, which will later be utilised with the Heroku-oriented Procfile.
    ```bash
    pip3 install gunicorn
    ```

8. With these packages installed, update your requirements.txt file using the following command:
    ```bash
    pip3 freeze > requirements.txt
    ```

9. With gunicorn now installed, we can now apply it to the Heroku Procfile. First create the Procfile then type the following within the Procfile.
    ```bash
    touch Procfile
    ```

    ```bash
    *Procfile*

    web: gunicorn folio.wsgi:application
    ```

10. Ensure that the hostname of your heroku app has been added to the list of ALLOWED_HOSTS within the applications settings.py file. Here is what the setting looks like within the original version of the app.
    ```python
    ALLOWED_HOSTS = ['folio-web-app.herokuapp.com', 'localhost']
    ```

> At the time of writing, Heroku disabled the GitHub connect feature that enables one to quickly deploy their GitHub repository to Heroku. For this reason, the following steps will assume that it is still currently the case and will demonstrate how to do it via the Heroku CLI. Given the simplicity & user friendliness of the GitHub connect feature, I do recommend attempting to use it (if it's been re-enabled of course). Steps on how to use this feature can be found [here](https://medium.com/featurepreneur/how-to-connect-github-to-heroku-be6ff27419d3). Credit goes to [this Stack Overflow answer](https://stackoverflow.com/a/71905270/15607265) that helped understand the Heroku CLI deployment flow.

11. To begin the deployment procedure via Heroku, you must first install the Heroku CLI. Steps in order to achieve this can be found [here](https://devcenter.heroku.com/articles/heroku-cli).

12. Once you've got the Heroku CLI installed, you can sign in to your Heroku account via the terminal by entering the following command and entering your details when they're asked of you by the CLI:
    ```bash
    heroku login -i
    ```

13. Assuming that you've already set up your Heroku app as instructed within previous steps, you now need to add a new remote Git repo using the Heroku CLI. You can do so by entering the following:
    ```bash
    heroku git:remote -a <heroku_app_name>
    ```

    You can check that this process has been successful by entering the following command:
    ```bash
    git remote -v
    ```

    The result of the previous command should present the following result:
    ```bash
    heroku  https://git.heroku.com/<your-heroku-app-name>.git (fetch)
    heroku  https://git.heroku.com/<your-heroku-app-name>.git (push)
    ```

14. You can now push the main branch to your newly created Heroku remote repo by entering the following command:
    ```bash
    git push heroku main 
    ```

15. Now the application has been deployed, you're now going to want to proceed with database migrations for the deployed app on Heroku. To achieve this (whilst logged in to the Heroku CLI), enter the following commands:
    ```bash
    heroku run python manage.py makemigrations
    ```

    ```bash
    heroku run python manage.py migrate
    ```

16. You can now run the following command to create a new admin account for the deployed application:
    ```bash
    heroku run python3 manage.py createsuperuser
    ```
    By adding "/admin" to the end of the deployed application url, you can then access the admin dashboard for the app and sign in with your newly created superuser.

[Return to Table of Contents &#8679;](#table-of-contents)

## Create an AWS S3 Bucket

The following are procedures that need to be undertaken in order to create an AWS S3 bucket that will hold and serve the application's static files.

1. Create an account / sign in with [Amazon AWS](https://aws.amazon.com/).

2. Within the search bar found in the navbar, search for S3 and click to open the S3 service within AWS.

3. Click the orange "Create Bucket" button within the S3 dashboard.

4. S3 will provide you with a form to fill out for the new S3 bucket. All you need to be concerned with for now are the following:
    - Bucket Name - make this unique and relevant to the app.
    - AWS Region - select the region closest to you.
    - Uncheck "Block all public access"
    
    You can then create the bucket by clicking the "Create Bucket" button and you'll then be re-directed to the S3 dashboard where you can see your newly created bucket.

5. Click the bucket you've recently created, navigate to the "Permissions" tab and click the "Edit" button found within the Bucket policy section. Here we're going to generate a new bucket policy. In order to do this, proceed with the following steps:
    1. Copy the Bucket ARN found within the bucket policy dashboard.
    2. Click the "Policy Generator" button at the top right of the dashboard.
    3. Within the policy generator form, proceed with the following steps:
        1. Set Type of Policy to S3 bucket.
        2. Type * in Principal field.
        3. Set actions to only 1 option being "GetObject".
        3. Paste the coped ARN into the ARN field.
        4. Click the "Add Statement" button.
        5. Click the "Generate Policy" button.
        6. Copy the provided policy JSON.
    4. Paste the policy JSON in the policy input found within the Edit bucket policy screen for your S3 bucket.
    5. IMPORTANT: Make sure to add "/*" at the end of the resource value.
    6. Click the "Save Changes" button.

[Return to Table of Contents &#8679;](#table-of-contents)

## Provide fol.io access to S3 Bucket via AWS IAM

The following are procedures that need to be undertaken in order to create set of access keys in order for the application to communicate correctly with AWS.

1. Ensure you have the required packages to communicate with AWS:
    ```bash
    pip3 install django_storages
    pip3 install boto3
    ```
    
    If you installed the packages just now, remembder to update your requirements.txt file by entering the following:
    ```bash
    pip3 freeze freeze > requirements.txt
    ```

2. Whilst signed in to AWS, navigate to the dropdown button containing your name and click "Security credentials". 

3. Open the access keys accordion and click "Create New Access Key".

4. Within the modal pop-up, show your keys by clicking the "Show Access Key" link. Keep a record of these keys by downloading the key file.

5. These are the keys you'll be attaching the respective AWS environment variables.

[Return to Table of Contents &#8679;](#table-of-contents)